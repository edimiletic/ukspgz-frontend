<!-- Updated src/app/components/games-assigned/games-assigned.component.html -->
<app-header></app-header>

<!-- Sidebar -->
<app-sidebar></app-sidebar>

<div class="main-layout">


  <!-- Content -->
  <section class="content">
    <!-- Admin Title and Actions -->
    <div *ngIf="isAdmin() && !isLoading" class="admin-header">
      <h1 class="admin-title">Sve Utakmice</h1>
      <button class="btn btn-primary btn-create-game" (click)="openCreateGameModal()">
        <i class="fas fa-plus"></i>
        Kreiraj Utakmicu
      </button>
    </div>

    <div *ngIf="!isAdmin() && !isLoading" class="header">
      <h1 class="title">Sve Utakmice</h1>
    </div>

    <!-- Filter Section -->
<!-- Updated Filter Section HTML - Replace your existing filter section with this -->
<div *ngIf="!isLoading" class="filter-section">
  <!-- Mobile Filter Toggle Button (visible only on mobile) -->
  <button class="mobile-filter-toggle" 
          [class.active]="isMobileFiltersOpen" 
          (click)="toggleMobileFilters()">
    <i class="fas fa-filter"></i>
    {{ isMobileFiltersOpen ? 'Sakrij filtere' : 'Prikaži filtere' }}
    <i class="fas fa-chevron-down"></i>
  </button>

  <!-- Filter Content (collapsible on mobile) -->
  <div class="filter-content" [class.open]="isMobileFiltersOpen">
    <div class="filter-row">
      <div class="filter-group">
        <label>Datum</label>
        <input type="date" class="form-control" [(ngModel)]="filterValues.date" (change)="onFilterChange()">
      </div>
      <div class="filter-group">
        <label>Mjesto</label>
        <input type="text" class="form-control" placeholder="Pretraži po mjestu" [(ngModel)]="filterValues.venue"
          (input)="onFilterChange()">
      </div>
      <div class="filter-group">
        <label>Domaći tim</label>
        <input type="text" class="form-control" placeholder="Pretraži po domaćem timu"
          [(ngModel)]="filterValues.homeTeam" (input)="onFilterChange()">
      </div>
      <div class="filter-group">
        <label>Gostujući tim</label>
        <input type="text" class="form-control" placeholder="Pretraži po gostujućem timu"
          [(ngModel)]="filterValues.awayTeam" (input)="onFilterChange()">
      </div>
      <div class="filter-group">
        <label>Natjecanje</label>
        <input type="text" class="form-control" placeholder="Pretraži po natjecanju"
          [(ngModel)]="filterValues.competition" (input)="onFilterChange()">
      </div>
      <div class="filter-group">
        <button class="btn btn-outline-secondary filter-btn" (click)="clearFilters()">
          <i class="fas fa-times"></i> Očisti
        </button>
      </div>
    </div>
  </div>
</div>

    <!-- Filter Status -->
    <div *ngIf="!isLoading && hasActiveFilters" class="admin-filter-status">
      <span class="filter-indicator">
        <i class="fas fa-filter"></i>
        Filteri aktivni - Ukupno prikazano: {{ totalFilteredCount }}
      </span>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="loading-spinner"></div>
      <p>Učitavanje utakmica...</p>
    </div>

    <!-- Main Content -->
    <div *ngIf="!isLoading">
      <!-- Pending Nominations Section -->
      <div class="description">
        <h2 *ngIf="!isAdmin()">Nominacije koje čekaju odluku</h2>
        <h2 *ngIf="isAdmin()">Nadolazeće Utakmice</h2>
        <div *ngIf="pendingGames.length === 0" class="no-games">
          <p *ngIf="!isAdmin()">Nema nominacija na čekanju</p>
          <p *ngIf="isAdmin()">Nema nadolazećih utakmica</p>
        </div>
        <div *ngIf="pendingGames.length > 0" class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Vrijeme</th>
                <th>Mjesto</th>
                <th>Natjecanje</th>
                <th>Ekipe</th>
                <!-- <th *ngIf="!isAdmin()">Moja uloga</th> -->
                <th>Sudački tim</th>
                <th *ngIf="!isAdmin()">Akcije</th>
                <th *ngIf="isAdmin()">Status</th>
                <th *ngIf="isAdmin()">Akcije</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let game of pendingDisplayedGames">
                <td>{{ formatDate(game.date) }}</td>
                <td>{{ game.time }}</td>
                <td>{{ game.venue }}</td>
                <td>{{ game.competition }}</td>
                <td>{{ getTeamsDisplay(game) }}</td>
                <!-- <td *ngIf="!isAdmin()">{{ getMyRole(game) }}</td> -->
                <td>
                  <div class="referees-summary" [innerHTML]="getAllRefereesFormatted(game)">
                  </div>
                </td>
                <td *ngIf="!isAdmin()">
                  <div class="action-buttons">
                    <button class="btn btn-success btn-sm" (click)="acceptAssignment(game._id)" title="Prihvati">
                      <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" (click)="rejectAssignment(game._id)" title="Odbij">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </td>
                <td *ngIf="isAdmin()">
                  <span class="status-badge" [ngClass]="getStatusClass(game)">
                    {{ getStatusDisplay(game) }}
                  </span>
                </td>
                <td *ngIf="isAdmin()">
                  <div class="admin-action-buttons">
                    <button class="btn btn-warning btn-sm" (click)="editGame(game)" title="Uredi utakmicu">
                      <i class="fas fa-pen"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" (click)="deleteGame(game)" title="Obriši utakmicu">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="pagination-container" *ngIf="pendingTotalPages > 1">
            <div class="pagination-info">
              Prikazano {{ pendingDisplayedGames.length }} od {{ pendingGames.length }} •
              Stranica {{ pendingPage }} od {{ pendingTotalPages }}
            </div>
            <div class="pagination">
              <button class="page-btn" [disabled]="pendingPage === 1" (click)="goToPendingPage(pendingPage - 1)">
                <i class="fas fa-chevron-left"></i>
              </button>

              <button class="page-btn" *ngFor="let page of getPendingPages()" [class.active]="page === pendingPage"
                (click)="goToPendingPage(page)">
                {{ page }}
              </button>

              <button class="page-btn" [disabled]="pendingPage === pendingTotalPages"
                (click)="goToPendingPage(pendingPage + 1)">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Confirmed Nominations Section - Only show for non-admin users -->
      <div class="description" *ngIf="!isAdmin()">
        <h2>Potvrđene nominacije</h2>
        <div *ngIf="confirmedGames.length === 0" class="no-games">
          <p>Nema potvrđenih nominacija</p>
        </div>
        <div *ngIf="confirmedGames.length > 0" class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Vrijeme</th>
                <th>Mjesto</th>
                <th>Natjecanje</th>
                <th>Ekipe</th>
                <!-- <th>Moja uloga</th> -->
                <th>Sudački tim</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let game of confirmedDisplayedGames">
                <td>{{ formatDate(game.date) }}</td>
                <td>{{ game.time }}</td>
                <td>{{ game.venue }}</td>
                <td>{{ game.competition }}</td>
                <td>{{ getTeamsDisplay(game) }}</td>
                <!-- <td>{{ getMyRole(game) }}</td> -->
                <td>
                  <div class="referees-summary" [innerHTML]="getAllRefereesFormatted(game)">
                  </div>
                </td>
                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(game)">
                    {{ getStatusDisplay(game) }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="pagination-container" *ngIf="confirmedTotalPages > 1">
            <div class="pagination-info">
              Prikazano {{ confirmedDisplayedGames.length }} od {{ confirmedGames.length }} •
              Stranica {{ confirmedPage }} od {{ confirmedTotalPages }}
            </div>
            <div class="pagination">
              <button class="page-btn" [disabled]="confirmedPage === 1" (click)="goToConfirmedPage(confirmedPage - 1)">
                <i class="fas fa-chevron-left"></i>
              </button>

              <button class="page-btn" *ngFor="let page of getConfirmedPages()" [class.active]="page === confirmedPage"
                (click)="goToConfirmedPage(page)">
                {{ page }}
              </button>

              <button class="page-btn" [disabled]="confirmedPage === confirmedTotalPages"
                (click)="goToConfirmedPage(confirmedPage + 1)">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Game History Section -->
      <!-- src/app/components/games-assigned/games-assigned.component.html -->
      <!-- Update the Game History Section -->



      <div class="description">
        <h3>Povijest utakmica</h3>
        <div *ngIf="gameHistory.length === 0" class="no-games">
          <p>Nema povijesti utakmica</p>
        </div>
        <div *ngIf="gameHistory.length > 0" class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Vrijeme</th>
                <th>Mjesto</th>
                <th>Natjecanje</th>
                <th>Ekipe</th>
                <th>Sudački tim</th>
                <th>Status</th>
                <!-- Add new Kontrola column for Admins and Delegats -->
                <th *ngIf="canAccessKontrola()">Kontrola</th>
                <!-- Add new View Kontrola column for Referees -->
                <th *ngIf="!canAccessKontrola()">Moja Kontrola</th>
                <th *ngIf="isAdmin()">Akcije</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let game of historyDisplayedGames">
                <td>{{ formatDate(game.date) }}</td>
                <td>{{ game.time }}</td>
                <td>{{ game.venue }}</td>
                <td>{{ game.competition }}</td>
                <td>{{ getTeamsDisplay(game) }}</td>
                <td>
                  <div class="referees-summary" [innerHTML]="getAllRefereesFormatted(game)">
                  </div>
                </td>
                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(game)">
                    {{ getStatusDisplay(game) }}
                  </span>
                </td>
                <!-- Add/Edit Kontrola column for Admins and Delegats -->
                <td *ngIf="canAccessKontrola()">
                  <div class="kontrola-actions">
                    <button class="btn btn-kontrola" (click)="openKontrolaModal(game)"
                      [title]="getKontrolaStatus(game._id) ? 'Uredi kontrolu' : 'Dodaj kontrolu'">
                      <i [class]="getKontrolaStatus(game._id) ? 'fas fa-edit' : 'fas fa-plus'"></i>
                    </button>
                  </div>
                </td>
                <!-- View Kontrola column for Referees -->
                <td *ngIf="!canAccessKontrola()">
                  <div class="view-kontrola-actions">
                    <!-- Case 1: User participated AND kontrola exists - Show eye button -->
                    <button *ngIf="canViewKontrola(game) && getKontrolaStatus(game._id)" class="btn btn-view-kontrola"
                      (click)="openViewKontrolaModal(game)" title="Pogledaj moju kontrolu">
                      <i class="fas fa-eye"></i>
                    </button>

                    <!-- Case 2: User participated BUT kontrola doesn't exist - Show clock icon -->
                    <span *ngIf="canViewKontrola(game) && !getKontrolaStatus(game._id)" class="no-kontrola"
                      title="Kontrola još nije kreirana">
                      <i class="fas fa-clock text-muted"></i>
                    </span>

                    <!-- Case 3: User did NOT participate - Show minus -->
                    <span *ngIf="!canViewKontrola(game)" class="no-access" title="Niste sudjelovali u ovoj utakmici">
                      <i class="fas fa-minus text-muted"></i>
                    </span>
                  </div>
                </td>
                <td *ngIf="isAdmin()">
                  <div class="admin-action-buttons">
                    <button class="btn btn-danger btn-sm" (click)="deleteGame(game)" title="Obriši utakmicu">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="pagination-container" *ngIf="historyTotalPages > 1">
            <div class="pagination-info">
              Prikazano {{ historyDisplayedGames.length }} od {{ gameHistory.length }} •
              Stranica {{ historyPage }} od {{ historyTotalPages }}
            </div>
            <div class="pagination">
              <button class="page-btn" [disabled]="historyPage === 1" (click)="goToHistoryPage(historyPage - 1)">
                <i class="fas fa-chevron-left"></i>
              </button>

              <button class="page-btn" *ngFor="let page of getHistoryPages()" [class.active]="page === historyPage"
                (click)="goToHistoryPage(page)">
                {{ page }}
              </button>

              <button class="page-btn" [disabled]="historyPage === historyTotalPages"
                (click)="goToHistoryPage(historyPage + 1)">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
            </div>

  </section>
</div>

<!-- Toast Notifications -->
<div class="toast-container">
  <div *ngIf="successMessage" class="toast toast-success">
    <span class="toast-emoji">✅</span>
    <span class="toast-message">{{ successMessage }}</span>
    <button class="toast-close" (click)="clearMessages()"><i class="fa-solid fa-xmark"></i></button>
  </div>

  <div *ngIf="errorMessage" class="toast toast-error">
    <span class="toast-emoji">❌</span>
    <span class="toast-message">{{ errorMessage }}</span>
    <button class="toast-close" (click)="clearMessages()"><i class="fa-solid fa-xmark"></i></button>
  </div>
</div>
<!-- Toast Notifications -->
<div class="toast-container">
  <div *ngIf="successMessage" class="toast toast-success">
    <span class="toast-emoji">✅</span>
    <span class="toast-message">{{ successMessage }}</span>
    <button class="toast-close" (click)="clearMessages()"><i class="fa-solid fa-xmark"></i></button>
  </div>

  <div *ngIf="errorMessage" class="toast toast-error">
    <span class="toast-emoji">❌</span>
    <span class="toast-message">{{ errorMessage }}</span>
    <button class="toast-close" (click)="clearMessages()"><i class="fa-solid fa-xmark"></i></button>
  </div>
</div>

<app-kontrola-modal [isOpen]="isKontrolaModalOpen" [game]="gameForKontrola" [isEditMode]="isKontrolaEditMode"
  (close)="closeKontrolaModal()" (kontrolaSaved)="onKontrolaSaved($event)">
</app-kontrola-modal>

<!-- Rejection Modal -->
<app-rejection-modal [isOpen]="isRejectionModalOpen" [gameInfo]="gameToReject" (close)="closeRejectionModal()"
  (reject)="onRejectionConfirmed($event)">
</app-rejection-modal>

<!-- Create Game Modal -->
<app-create-game-modal [isOpen]="isCreateGameModalOpen" (close)="closeCreateGameModal()"
  (gameCreated)="onGameCreated($event)">
</app-create-game-modal>

<!-- Edit Game Modal -->
<app-edit-game-modal [isOpen]="isEditGameModalOpen" [game]="gameToEdit" (close)="closeEditGameModal()"
  (gameUpdated)="onGameUpdated($event)">
</app-edit-game-modal>

<!-- Confirmation Modal -->
<app-delete-game-modal [isOpen]="isConfirmationModalOpen" [confirmationData]="confirmationData"
  (close)="closeConfirmationModal()" (confirm)="onDeleteConfirmed($event)">
</app-delete-game-modal>

<app-view-kontrola-modal [isOpen]="isViewKontrolaModalOpen" [game]="gameForViewKontrola"
  [currentUserId]="currentUser?._id || ''" (close)="closeViewKontrolaModal()">
</app-view-kontrola-modal>

<app-footer></app-footer>